import esbuild from 'esbuild';
import process from 'process';
import { fileURLToPath } from 'url';
import path from 'path';
import fs from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const banner = `/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
`;

const prod = process.argv[2] === 'production';
const outputDir = path.join(__dirname, 'marginalia');

// 确保输出目录存在
if (!fs.existsSync(outputDir)) {
  fs.mkdirSync(outputDir);
}

// 复制文件到输出目录
function copyFiles() {
  const filesToCopy = [
    path.join(__dirname, 'manifest.json'),
    path.join(__dirname, 'styles.css')
  ];

  filesToCopy.forEach(file => {
    const fileName = path.basename(file);
    const dest = path.join(outputDir, fileName);
    fs.copyFileSync(file, dest);
    console.log(`Copied ${fileName} to ${outputDir}`);
  });
}

esbuild.build({
  banner: { js: banner },
  entryPoints: [path.join(__dirname, 'src', 'main.ts')],
  bundle: true,
  external: ['obsidian'],
  format: 'cjs',
  watch: !prod,
  target: 'es2018',
  logLevel: 'info',
  sourcemap: prod ? false : 'inline',
  treeShaking: true,
  outfile: path.join(outputDir, 'main.js'),
}).then(() => {
  // 构建完成后复制文件
  copyFiles();
  
  // 删除根目录下的 main.js（如果存在）
  const rootMainJs = path.join(__dirname, 'main.js');
  if (fs.existsSync(rootMainJs)) {
    fs.unlinkSync(rootMainJs);
    console.log('Deleted root main.js file');
  }
}).catch(() => process.exit(1));
